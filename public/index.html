<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#071021" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Municipales 2026 News V3</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main>
    <h1>Municipales 2026 News V3 <span id="article-count">(0)</span></h1>
    <p class="subtitle">DerniÃ¨re mise Ã  jour: <span id="updated">â€“</span> â€¢ <small class="info">Articles â‰¤ 1 mois, triÃ©s du plus rÃ©cent au moins rÃ©cent</small></p>

    <!-- Month tabs for pagination -->
    <div id="month-tabs" class="month-tabs" role="tablist" aria-label="Filtrer par mois">
    </div>

    <div id="newsapi-banner" class="banner" role="status" aria-live="polite" hidden>
      <span id="newsapi-banner-text"></span>
      <button id="newsapi-banner-close" aria-label="Fermer">âœ–</button>
    </div>

    <div class="controls">
      <button id="refresh">ðŸ”„ RafraÃ®chir</button>
      <button id="filter-maudet" title="Mettre en Ã©vidence Maudet">ðŸ”Ž Maudet</button>
      <label for="filter-town" class="visually-hidden">Filtrer par ville</label>
      <!-- keep the native select for accessibility but hide it; custom listbox provides the visual style -->
      <select id="filter-town" title="Filtrer par ville" aria-hidden="true" style="position:absolute;left:-9999px;top:auto;opacity:0;pointer-events:none;">
        <option value="">Toutes les villes</option>
        <option value="limoges">Limoges</option>
        <option value="saint-junien">Saint-Junien</option>
        <option value="panazol">Panazol</option>
        <option value="couzeix">Couzeix</option>
        <option value="isle">Isle</option>
        <option value="feytiat">Feytiat</option>
        <option value="condat-sur-vienne">Condat-sur-Vienne</option>
        <option value="le palais sur vienne">Le Palais-sur-Vienne</option>
      </select>

      <!-- Custom cyberpunk-styled listbox (keeps keyboard support) -->
      <div id="custom-town-listbox" class="custom-listbox" role="listbox" tabindex="0" aria-label="Filtrer par ville">
        <button class="cb-selected" aria-haspopup="listbox" aria-expanded="false">Toutes les villes <span class="cb-arrow">â–¾</span></button>
        <ul class="cb-options" role="presentation" hidden></ul>
      </div>
      <div id="active-filter" class="active-filter" hidden></div>
    </div>
    <div id="status">Chargement des derniÃ¨res news municipales (Limoges 2026)...</div>
    <ul id="articles"></ul>
  </main>

  <script>
    const statusEl = document.getElementById('status');
    const articlesEl = document.getElementById('articles');
    const updatedEl = document.getElementById('updated');
    const refreshBtn = document.getElementById('refresh');
    const filterMaudetBtn = document.getElementById('filter-maudet');
    const articleCountEl = document.getElementById('article-count');
    let suppressSelectChange = false; // prevent select change handler from overriding programmatic toggles
    
    // Month pagination
    let monthlyArticles = {};
    let availableMonths = [];
    let currentMonth = null; // null means show all articles

    function showToast(msg, timeout = 3000){
      try{
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.body.appendChild(t);
        // allow CSS transition
        setTimeout(()=> t.classList.add('visible'), 10);
        setTimeout(()=>{ t.classList.remove('visible'); setTimeout(()=> t.remove(), 400); }, timeout);
      }catch(e){ console.warn('showToast failed', e && e.message ? e.message : e); }
    }

    async function loadNews(opts = {}) {
      const notify = opts.notify === true;
      statusEl.textContent = 'Chargementâ€¦';
      articlesEl.innerHTML = '';

      try {
        const res = await fetch(`/api/news?limit=200`);
        if (!res.ok) throw new Error('Erreur rÃ©seau');
        const json = await res.json();
        const articles = json.articles || [];
        
        // Store monthly articles and months
        monthlyArticles = json.monthlyArticles || {};
        availableMonths = json.months || [];
        
        // Update article count
        if (articleCountEl) {
          articleCountEl.textContent = '(' + articles.length + ')';
        }

        // If server capped the NewsAPI window, inform the user with a toast and a persistent banner
        try{
          if(json.debug && json.debug.newsApiCapped){
            const usedDays = Math.round((json.debug.usedHoursForNewsApi || 720) / 24);
            const requested = json.debug.requestedHours ? Math.round(json.debug.requestedHours/24) : null;
            const note = requested && requested !== usedDays ? `Recherche NewsAPI limitÃ©e Ã  ${usedDays} jours (demandÃ©: ${requested} jours)` : `Recherche NewsAPI limitÃ©e Ã  ${usedDays} jours`;
            showToast(note, 5000);

            // show persistent banner
            try{
              const banner = document.getElementById('newsapi-banner');
              const bannerText = document.getElementById('newsapi-banner-text');
              if(banner && bannerText){
                bannerText.textContent = note + ' â€” Les rÃ©sultats peuvent provenir du fallback RSS.';
                banner.hidden = false;
                banner.classList.add('visible');
              }
            }catch(e){ console.warn('banner show failed', e && e.message ? e.message : e); }
          }
        }catch(e){ console.warn('debug toast failed', e && e.message ? e.message : e); }

        if (articles.length === 0) {
          statusEl.textContent = "Aucun article trouvÃ© pour les municipales Limoges 2026.";
          updatedEl.textContent = new Date().toLocaleString();
          updateMonthTabs();
          if (notify) showToast('Recherche mise Ã  jour â€” 0 articles');
          return;
        }

        // store current articles and render
        currentArticles = articles;
        updateMonthTabs();

        statusEl.textContent = '';
        updatedEl.textContent = new Date().toLocaleString();
        if (json.source) {
          // show source and count briefly
          statusEl.textContent = `Source: ${json.source} â€” ${articles.length} article(s)`;
          setTimeout(()=>{ statusEl.textContent = '' }, 3500);
        }

        // render (apply any active filter) and report visible count
        const visible = applyFilter();
        if (notify) showToast(`Recherche mise Ã  jour â€” ${visible} article(s) visibles`);
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Impossible de charger les news.';
        if (notify) showToast('Erreur: impossible de mettre Ã  jour la recherche');
      }
    }

    refreshBtn.addEventListener('click', loadNews);
    const filterTownEl = document.getElementById('filter-town');

    // initialize custom listbox UI that syncs with the native select
    function initCustomTownListbox(selectEl){
      if(!selectEl) return;
      const box = document.getElementById('custom-town-listbox');
      const button = box.querySelector('.cb-selected');
      const ul = box.querySelector('.cb-options');

      // build options
      ul.innerHTML = '';
      Array.from(selectEl.options).forEach(opt => {
        const li = document.createElement('li');
        li.className = 'cb-option';
        li.tabIndex = -1;
        li.setAttribute('data-value', opt.value);
        li.setAttribute('role', 'option');
        li.textContent = opt.textContent;
        ul.appendChild(li);
      });

      function close(){ ul.hidden = true; box.classList.remove('open'); button.setAttribute('aria-expanded','false'); }
      function open(){ ul.hidden = false; box.classList.add('open'); button.setAttribute('aria-expanded','true'); const sel = ul.querySelector('.cb-option.selected'); if(sel) sel.focus(); }

      button.addEventListener('click', (e)=>{ e.preventDefault(); if(ul.hidden) open(); else close(); });

      ul.addEventListener('click', (e)=>{
        const li = e.target.closest('.cb-option'); if(!li) return;
        selectEl.value = li.getAttribute('data-value'); selectEl.dispatchEvent(new Event('change'));
        close();
      });

      // keyboard handling for accessibility
      box.addEventListener('keydown', (e)=>{
        const openKeys = ['Enter',' ','ArrowDown'];
        if(openKeys.includes(e.key) && ul.hidden){ e.preventDefault(); open(); return; }
        if(e.key === 'Escape'){ close(); button.focus(); return; }
        const focused = document.activeElement; if(!ul.contains(focused)) return;
        if(e.key === 'ArrowDown'){ e.preventDefault(); const next = focused.nextElementSibling || ul.firstElementChild; if(next) next.focus(); }
        if(e.key === 'ArrowUp'){ e.preventDefault(); const prev = focused.previousElementSibling || ul.lastElementChild; if(prev) prev.focus(); }
        if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); focused.click(); }
      });

      // keep native select in sync and apply filter when changed
      selectEl.addEventListener('change', ()=>{
        const v = selectEl.value || '';
        const opt = selectEl.options[selectEl.selectedIndex];
        button.innerHTML = (opt ? opt.textContent : 'Toutes les villes') + ' <span class="cb-arrow">â–¾</span>';
        ul.querySelectorAll('.cb-option').forEach(li => { const sel = li.getAttribute('data-value') === v; li.classList.toggle('selected', sel); li.setAttribute('aria-selected', sel ? 'true' : 'false'); });
        // respect suppressSelectChange flag: if true, update visual only and do not override activeFilter
        if(!suppressSelectChange){
          activeFilter = v || null;
          applyFilter();
        }
      });

      // initialize
      selectEl.dispatchEvent(new Event('change'));

      // close when clicking outside
      document.addEventListener('click', (e)=>{ if(!box.contains(e.target)) close(); });
    }

    if (filterMaudetBtn){
      filterMaudetBtn.addEventListener('click', (e) => {
        e.preventDefault();
        // compute toggled value
        const toggled = (activeFilter && normalizeString(activeFilter) === 'maudet') ? null : 'maudet';
        // clear the select visually without letting its change handler override our toggled value
        if(filterTownEl){
          suppressSelectChange = true;
          filterTownEl.value = '';
          filterTownEl.dispatchEvent(new Event('change'));
          suppressSelectChange = false;
        }
        activeFilter = toggled;
        
        // Toggle active class on Maudet button
        if(activeFilter && normalizeString(activeFilter) === 'maudet'){
          filterMaudetBtn.classList.add('active');
        } else {
          filterMaudetBtn.classList.remove('active');
        }
        
        applyFilter();
      });
    }

    // Town filter listbox: set activeFilter to selected town or clear
    if(filterTownEl){
      initCustomTownListbox(filterTownEl);
    }


    // Autoload: sync removed tags first, then fetch news
    (async function init(){
      await syncRemovedTagsFromServer();
      await loadNews();
    })();

    // Filtering and rendering helpers
    let currentArticles = [];
    let activeFilter = null;
    const activeFilterEl = document.getElementById('active-filter');
    // removedTags UI element removed; placeholder variable omitted
    const removedListEl = document.getElementById('removed-list');

    // load removed tags from localStorage (store as raw labels) and sync with server
    const removedTags = new Set(JSON.parse(localStorage.getItem('removedTags') || '[]'));
    function saveRemovedTags(){ try{ localStorage.setItem('removedTags', JSON.stringify(Array.from(removedTags))); }catch(e){} }
    function removedTagsHas(label){ return removedTags.has(label) || removedTags.has(normalizeString(label)); }

    // fetch server-side stored removed tags and merge (global persistence)
    async function syncRemovedTagsFromServer(){
      try{
        const r = await fetch('/api/filters');
        if(r.ok){
          const j = await r.json();
          // replace local removed tags with server authoritative list (start from clean state)
          removedTags.clear();
          (j.removed || []).forEach(t => removedTags.add(t));
          saveRemovedTags();
          renderRemovedTags();
          // ensure any active filter is cleared when server-side list changes
          activeFilter = null;
          applyFilter();
        }
      }catch(e){ console.warn('Could not sync removed tags from server', e && e.message ? e.message : e); }
    }
    // call sync on init
    syncRemovedTagsFromServer();

    // persist a change to server (best-effort)
    async function persistTag(action, match){
      try{
        await fetch('/api/filters', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action, tag: match }) });
      }catch(e){ console.warn('Persist failed', e && e.message ? e.message : e); }
    }

    // initialize active filter UI (use style.display and event delegation)
    if(activeFilterEl){
      activeFilterEl.style.display = 'none';
      activeFilterEl.addEventListener('click', (e) => {
        const t = e.target;
        if(t && t.id === 'clear-filter'){
          activeFilter = null;
          applyFilter();
        }
      });
    }

    // `removed-tags` UI removed: no-op renderer kept for compatibility
    function renderRemovedTags(){ /* intentionally no-op */ }

    function renderArticles(list){
      articlesEl.innerHTML = '';
      if(!list || list.length === 0){
        statusEl.textContent = 'Aucun article visible avec le filtre actuel.';
        renderRemovedTags();
        return;
      }
      statusEl.textContent = '';
      for(const a of list){
        const li = document.createElement('li');
        li.className = 'article';
        const matchesHtml = (a.matches && a.matches.length) ? a.matches.map(m => {
          const isRemoved = removedTagsHas(m);
          let cls = isRemoved ? 'tag removed' : ((a.primaryMatch && normalizeString(m) === normalizeString(a.primaryMatch)) ? 'tag primary' : 'tag');
          if (normalizeString(m).includes('maudet')) cls += ' maudet';
          const label = escapeHtml(m);
          return `<span class="${cls}" data-match="${escapeHtml(m)}"><span class="label">${label}</span></span>`;
        }).join(' ') : '';

        li.innerHTML = `
          <a class="title" href="${a.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(a.title)}</a>
          <div class="meta">${escapeHtml(a.source || '')} â€” ${a.publishedAt ? new Date(a.publishedAt).toLocaleString() : ''}</div>
          ${matchesHtml ? `<div class="matches">${matchesHtml}</div>` : ''}
          <p class="desc">${escapeHtml(a.description || '')}</p>
        `;
        // add highlight class if this article mentions Maudet
        const isMaudet = (a.matches || []).some(m => normalizeString(m).includes('maudet') || normalizeString(m) === 'maudet');
        if (isMaudet) li.classList.add('maudet');
        articlesEl.appendChild(li);
      }
      renderRemovedTags();
    }

    function normalForm(s){ return (normalizeString(s)||'').replace(/[^a-z0-9]+/g,''); }
    function applyFilter(){
      let list = [...currentArticles];
      
      // Filter by month if selected
      if (currentMonth && monthlyArticles[currentMonth]) {
        list = monthlyArticles[currentMonth];
      }
      
      let renderedList = [];
      if(!activeFilter){
        renderArticles(list);
        renderedList = list;
        if(activeFilterEl){ activeFilterEl.style.display = 'none'; activeFilterEl.innerHTML = ''; }
      } else {
        const target = normalForm(activeFilter);
        // Special-case 'maudet' filter: match any tag that contains 'maudet' (e.g., 'damien maudet')
        const filtered = list.filter(a => (a.matches || []).some(m => {
          const nm = normalForm(m);
          if (target === 'maudet') return nm.includes('maudet');
          return nm === target;
        }));
        if(activeFilterEl){
          activeFilterEl.style.display = 'inline-block';
          activeFilterEl.innerHTML = `Filtre: <strong>${escapeHtml(activeFilter)}</strong> â€” ${filtered.length} article(s) <button id="clear-filter">âœ–</button>`;
        }
        const sliced = filtered.slice(0,100);
        renderArticles(sliced);
        renderedList = sliced;
      }
      return renderedList.length;
    }

    // removeTag removed: tags can no longer be deleted from articles in the UI.
    // restoreTag / restoreAll removed from UI: operations are no longer available via the client UI.

    // utility: normalize for comparison and escape for HTML injection safety
    function normalizeString(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // tag click handler (delegation) â€” removed/restore actions hidden; click applies filter
    articlesEl.addEventListener('click', (e)=>{
      const t = e.target;
      const tagSpan = t.closest('.tag');
      if(!tagSpan) return;
      const match = tagSpan.getAttribute('data-match');
      activeFilter = match;
      // if the match corresponds to a town option, set the hidden select (and dispatch change so custom UI updates)
      try{
        if(filterTownEl){
          const norm = normalForm(match);
          let found = false;
          for(const opt of filterTownEl.options){ if(normalForm(opt.value) === norm){ filterTownEl.value = opt.value; found = true; break } }
          if(!found) filterTownEl.value = '';
          filterTownEl.dispatchEvent(new Event('change'));
        }
      }catch(_){ }
      applyFilter();
    });

    // Restore-all UI removed â€” no button handler needed.

    // Quick Limoges filter removed from UI.
    // NewsAPI banner dismissal
    const bannerClose = document.getElementById('newsapi-banner-close');
    if(bannerClose){
      bannerClose.addEventListener('click', (e)=>{ e.preventDefault(); try{ const b = document.getElementById('newsapi-banner'); if(b){ b.hidden = true; b.classList.remove('visible'); } }catch(_){}});
    }

    // Month tabs management
    function updateMonthTabs() {
      const tabsContainer = document.getElementById('month-tabs');
      if (!tabsContainer) return;
      tabsContainer.innerHTML = '';
      
      // "All months" tab
      const allBtn = document.createElement('button');
      allBtn.textContent = 'Tous les mois';
      allBtn.role = 'tab';
      allBtn.setAttribute('aria-selected', currentMonth === null);
      allBtn.className = currentMonth === null ? 'active' : '';
      allBtn.addEventListener('click', () => {
        currentMonth = null;
        applyFilter();
        updateMonthTabs();
      });
      tabsContainer.appendChild(allBtn);
      
      // Month tabs
      for (const month of availableMonths) {
        const btn = document.createElement('button');
        const [year, monthNum] = month.split('-');
        const date = new Date(year, parseInt(monthNum) - 1, 1);
        const label = date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
        btn.textContent = label;
        btn.role = 'tab';
        btn.setAttribute('aria-selected', currentMonth === month);
        btn.className = currentMonth === month ? 'active' : '';
        btn.addEventListener('click', () => {
          currentMonth = month;
          applyFilter();
          updateMonthTabs();
        });
        tabsContainer.appendChild(btn);
      }
    }
  </script>
</body>
</html>
