<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>20 derniÃ¨res news â€” Municipales Limoges 2026</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main>
    <h1>ðŸ“° 20 derniÃ¨res news â€” Municipales Limoges 2026</h1>
    <p class="subtitle">DerniÃ¨re mise Ã  jour: <span id="updated">â€“</span> â€¢ <small class="info">Articles â‰¤ 1 mois, triÃ©s du plus rÃ©cent au moins rÃ©cent</small></p>

    <div id="newsapi-banner" class="banner" role="status" aria-live="polite" hidden>
      <span id="newsapi-banner-text"></span>
      <button id="newsapi-banner-close" aria-label="Fermer">âœ–</button>
    </div>

    <div class="controls">
      <button id="refresh">ðŸ”„ RafraÃ®chir</button>
      <button id="filter-maudet" title="Mettre en Ã©vidence Maudet">ðŸ”Ž Maudet</button>
      <select id="lang">
        <option value="fr">FranÃ§ais</option>
        <option value="en">Anglais</option>
        <option value="all">Toutes langues</option>
      </select>
      <label for="theme" class="visually-hidden">ThÃ¨me</label>
      <select id="theme" aria-label="SÃ©lecteur de thÃ¨me">
        <option value="dark">Sombre</option>
        <option value="light">Clair</option>
      </select>
      <div id="active-filter" class="active-filter" hidden></div>
    </div>
    <div id="status">Chargement des derniÃ¨res news municipales (Limoges 2026)...</div>
    <ul id="articles"></ul>
  </main>

  <script>
    const statusEl = document.getElementById('status');
    const articlesEl = document.getElementById('articles');
    const updatedEl = document.getElementById('updated');
    const refreshBtn = document.getElementById('refresh');
    const langEl = document.getElementById('lang');
    const filterMaudetBtn = document.getElementById('filter-maudet');

    function showToast(msg, timeout = 3000){
      try{
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.body.appendChild(t);
        // allow CSS transition
        setTimeout(()=> t.classList.add('visible'), 10);
        setTimeout(()=>{ t.classList.remove('visible'); setTimeout(()=> t.remove(), 400); }, timeout);
      }catch(e){ console.warn('showToast failed', e && e.message ? e.message : e); }
    }

    async function loadNews(opts = {}) {
      const notify = opts.notify === true;
      statusEl.textContent = 'Chargementâ€¦';
      articlesEl.innerHTML = '';
      const lang = langEl.value;
      const langParam = lang === 'all' ? '' : `&lang=${lang}`;

      try {
        const res = await fetch(`/api/news?limit=50${langParam}`);
        if (!res.ok) throw new Error('Erreur rÃ©seau');
        const json = await res.json();
        const articles = json.articles || [];

        // If server capped the NewsAPI window, inform the user with a toast and a persistent banner
        try{
          if(json.debug && json.debug.newsApiCapped){
            const usedDays = Math.round((json.debug.usedHoursForNewsApi || 720) / 24);
            const requested = json.debug.requestedHours ? Math.round(json.debug.requestedHours/24) : null;
            const note = requested && requested !== usedDays ? `Recherche NewsAPI limitÃ©e Ã  ${usedDays} jours (demandÃ©: ${requested} jours)` : `Recherche NewsAPI limitÃ©e Ã  ${usedDays} jours`;
            showToast(note, 5000);

            // show persistent banner
            try{
              const banner = document.getElementById('newsapi-banner');
              const bannerText = document.getElementById('newsapi-banner-text');
              if(banner && bannerText){
                bannerText.textContent = note + ' â€” Les rÃ©sultats peuvent provenir du fallback RSS.';
                banner.hidden = false;
                banner.classList.add('visible');
              }
            }catch(e){ console.warn('banner show failed', e && e.message ? e.message : e); }
          }
        }catch(e){ console.warn('debug toast failed', e && e.message ? e.message : e); }

        if (articles.length === 0) {
          statusEl.textContent = "Aucun article trouvÃ© pour les municipales Limoges 2026.";
          updatedEl.textContent = new Date().toLocaleString();
          if (notify) showToast('Recherche mise Ã  jour â€” 0 articles');
          return;
        }

        // store current articles and render
        currentArticles = articles;

        statusEl.textContent = '';
        updatedEl.textContent = new Date().toLocaleString();
        if (json.source) {
          // show source and count briefly
          statusEl.textContent = `Source: ${json.source} â€” ${articles.length} article(s)`;
          setTimeout(()=>{ statusEl.textContent = '' }, 3500);
        }

        // render (apply any active filter) and report visible count
        const visible = applyFilter();
        if (notify) showToast(`Recherche mise Ã  jour â€” ${visible} article(s) visibles`);
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Impossible de charger les news.';
        if (notify) showToast('Erreur: impossible de mettre Ã  jour la recherche');
      }
    }

    refreshBtn.addEventListener('click', loadNews);
    if (filterMaudetBtn){
      filterMaudetBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (activeFilter && normalizeString(activeFilter) === 'maudet') { activeFilter = null; } else { activeFilter = 'maudet'; }
        applyFilter();
      });
    }


    // Autoload: sync removed tags first, then fetch news
    (async function init(){
      await syncRemovedTagsFromServer();
      await loadNews();
    })();

    // Theme selector: persist preference in localStorage and apply
    const themeEl = document.getElementById('theme');
    function applyTheme(theme){
      if(theme === 'light'){
        document.body.classList.add('light');
      } else {
        document.body.classList.remove('light');
      }
      try{ localStorage.setItem('theme', theme); }catch(e){}
    }

    // initialize
    const savedTheme = (() => {
      try{ return localStorage.getItem('theme'); }catch(e){ return null }
    })() || (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
    applyTheme(savedTheme);
    if(themeEl) themeEl.value = savedTheme;
    if(themeEl) themeEl.addEventListener('change', (e)=> applyTheme(e.target.value));

    // Filtering and rendering helpers
    let currentArticles = [];
    let activeFilter = null;
    const activeFilterEl = document.getElementById('active-filter');
    // removedTags UI element removed; placeholder variable omitted
    const removedListEl = document.getElementById('removed-list');

    // load removed tags from localStorage (store as raw labels) and sync with server
    const removedTags = new Set(JSON.parse(localStorage.getItem('removedTags') || '[]'));
    function saveRemovedTags(){ try{ localStorage.setItem('removedTags', JSON.stringify(Array.from(removedTags))); }catch(e){} }
    function removedTagsHas(label){ return removedTags.has(label) || removedTags.has(normalizeString(label)); }

    // fetch server-side stored removed tags and merge (global persistence)
    async function syncRemovedTagsFromServer(){
      try{
        const r = await fetch('/api/filters');
        if(r.ok){
          const j = await r.json();
          // replace local removed tags with server authoritative list (start from clean state)
          removedTags.clear();
          (j.removed || []).forEach(t => removedTags.add(t));
          saveRemovedTags();
          renderRemovedTags();
          // ensure any active filter is cleared when server-side list changes
          activeFilter = null;
          applyFilter();
        }
      }catch(e){ console.warn('Could not sync removed tags from server', e && e.message ? e.message : e); }
    }
    // call sync on init
    syncRemovedTagsFromServer();

    // persist a change to server (best-effort)
    async function persistTag(action, match){
      try{
        await fetch('/api/filters', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action, tag: match }) });
      }catch(e){ console.warn('Persist failed', e && e.message ? e.message : e); }
    }

    // initialize active filter UI (use style.display and event delegation)
    if(activeFilterEl){
      activeFilterEl.style.display = 'none';
      activeFilterEl.addEventListener('click', (e) => {
        const t = e.target;
        if(t && t.id === 'clear-filter'){
          activeFilter = null;
          applyFilter();
        }
      });
    }

    // `removed-tags` UI removed: no-op renderer kept for compatibility
    function renderRemovedTags(){ /* intentionally no-op */ }

    function renderArticles(list){
      articlesEl.innerHTML = '';
      if(!list || list.length === 0){
        statusEl.textContent = 'Aucun article visible avec le filtre actuel.';
        renderRemovedTags();
        return;
      }
      statusEl.textContent = '';
      for(const a of list){
        const li = document.createElement('li');
        li.className = 'article';
        const matchesHtml = (a.matches && a.matches.length) ? a.matches.map(m => {
          const isRemoved = removedTagsHas(m);
          let cls = isRemoved ? 'tag removed' : ((a.primaryMatch && normalizeString(m) === normalizeString(a.primaryMatch)) ? 'tag primary' : 'tag');
          if (normalizeString(m).includes('maudet')) cls += ' maudet';
          const label = escapeHtml(m);
          return `<span class="${cls}" data-match="${escapeHtml(m)}"><span class="label">${label}</span></span>`;
        }).join(' ') : '';

        li.innerHTML = `
          <a class="title" href="${a.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(a.title)}</a>
          <div class="meta">${escapeHtml(a.source || '')} â€” ${a.publishedAt ? new Date(a.publishedAt).toLocaleString() : ''}</div>
          ${matchesHtml ? `<div class="matches">${matchesHtml}</div>` : ''}
          <p class="desc">${escapeHtml(a.description || '')}</p>
        `;
        // add highlight class if this article mentions Maudet
        const isMaudet = (a.matches || []).some(m => normalizeString(m).includes('maudet') || normalizeString(m) === 'maudet');
        if (isMaudet) li.classList.add('maudet');
        articlesEl.appendChild(li);
      }
      renderRemovedTags();
    }

    function applyFilter(){
      let renderedList = [];
      if(!activeFilter){
        renderArticles(currentArticles);
        renderedList = currentArticles;
        if(activeFilterEl){ activeFilterEl.style.display = 'none'; activeFilterEl.innerHTML = ''; }
      } else {
        const filtered = currentArticles.filter(a => (a.matches || []).some(m => normalizeString(m) === normalizeString(activeFilter)));
        if(activeFilterEl){
          activeFilterEl.style.display = 'inline-block';
          activeFilterEl.innerHTML = `Filtre: <strong>${escapeHtml(activeFilter)}</strong> â€” ${filtered.length} article(s) <button id="clear-filter">âœ–</button>`;
        }
        const sliced = filtered.slice(0,50);
        renderArticles(sliced);
        renderedList = sliced;
      }
      return renderedList.length;
    }

    // removeTag removed: tags can no longer be deleted from articles in the UI.
    // restoreTag / restoreAll removed from UI: operations are no longer available via the client UI.

    // utility: normalize for comparison and escape for HTML injection safety
    function normalizeString(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // tag click handler (delegation) â€” removed/restore actions hidden; click applies filter
    articlesEl.addEventListener('click', (e)=>{
      const t = e.target;
      const tagSpan = t.closest('.tag');
      if(!tagSpan) return;
      const match = tagSpan.getAttribute('data-match');
      activeFilter = match; applyFilter();
    });

    // Restore-all UI removed â€” no button handler needed.

    // Quick Limoges filter removed from UI.
    // NewsAPI banner dismissal
    const bannerClose = document.getElementById('newsapi-banner-close');
    if(bannerClose){
      bannerClose.addEventListener('click', (e)=>{ e.preventDefault(); try{ const b = document.getElementById('newsapi-banner'); if(b){ b.hidden = true; b.classList.remove('visible'); } }catch(_){}});
    }
  </script>
</body>
</html>
